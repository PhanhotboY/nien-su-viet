name: Deploy Auth Service

on:
  push:
    branches: ['master']
    paths:
      - 'apps/auth/**'
      - 'libs/**'
      - '.github/workflows/auth-service.yml'
      - 'package.json'
    paths-ignore:
      - 'docs/**'
      - 'apps/client/**'
  pull_request:
    branches: ['master']
    paths:
      - 'apps/auth/**'
      - 'libs/**'
      - '.github/workflows/auth-service.yml'
      - 'package.json'
    paths-ignore:
      - 'docs/**'
      - 'apps/client/**'

jobs:
  deploy-auth-service:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DOCEAN_NSV_SSH_HOST }}
          username: ${{ secrets.DOCEAN_NSV_SSH_USER }}
          key: ${{ secrets.DOCEAN_NSV_SSH_SECRET }}
          script: |
            cd ~/workdir/nien-su-viet
            git pull origin master
            bun install
            bun run build auth
            pm2 reload auth-service || pm2 start ecosystem.config.js --only auth-service
